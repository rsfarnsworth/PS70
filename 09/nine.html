<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- UIKit -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.15.22/dist/css/uikit.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.15.22/dist/js/uikit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.15.22/dist/js/uikit-icons.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans&display=swap" rel="stylesheet">

    <title>Week 9</title>

    <link rel="stylesheet" href="../styles/fonts.css">
    <link rel="stylesheet" href="../styles/main.css">

    <link rel="icon" href="../../resources/icons/ps70_icon.svg">
</head>

<body>
    <nav class="uk-navbar uk-navbar-container uk-navbar-transparent uk-margin" uk-navbar>
        <div class="uk-navbar-left uk-margin-medium-left">
            <a class="uk-navbar-item uk-logo" href="https://rsfarnsworth.github.io/PS70/">PS 70</a>
        </div>
        <div class="uk-navbar-right uk-margin-medium-right">
            <a class="uk-navbar-toggle uk-navbar-toggle-animate" uk-navbar-toggle-icon href="#"></a>
            <div class="uk-navbar-dropdown">
                <ul class="uk-nav uk-navbar-dropdown-nav">
                    <li><a href="https://rsfarnsworth.github.io/PS70//about.html">About</a></li>
                    <li><a href="https://rsfarnsworth.github.io/PS70//assignments.html">Assignments</a></li>
                    <li><a href="https://rsfarnsworth.github.io/PS70//.html">Final Project</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="uk-container">
        <div class="uk-text-center">
            <h1 class="uk-margin-medium-top assignment-title">Week 9</h1>
            <h3 class="assignment-subtitle">Radio, Wifi, and Bluetooth</h3>
        </div>

        <div class="uk-container-small uk-margin-large-top uk-margin-auto">
            <div uk-grid>
                <div class="uk-grid-item-match uk-width-1-3@s">
                    <div>
                        <h3>Assignment Prompt</h3>
                    </div>
                </div>
                <div class="uk-width-2-3@s">

                    <div class="uk-text-left">
                        <p>
                            Work with a partner or group of 3. Program one or more microcontroller(s) to obtain and respond 
                            to information from the internet or radio. Your project should include at least one input and one 
                            output.
                        </p>
                    </div>

                </div>
            </div>

            <div uk-grid>
                <div class="uk-grid-item-match uk-width-1-3@s">
                    <div>
                        <h3>Process</h3>
                    </div>
                </div>
                <div class="uk-width-2-3@s">

                    <div class="uk-text-left">
                        <p>
                            For this assignment, I worked with Bernie and we wanted to do something involving the OpenAI API for 
                            chat GPT, and the OLED screens connected to an ESP32. The original idea was to use a sort of feedback 
                            loop with chat GPT itself to create a movie script dialogue because we thought this would lead to 
                            funnier responses than ai itself generating a script in a single go. This however proved difficult 
                            because of the length of responses themselves, also because we needed a better input method. Another
                            difficulty was that our first screen was broken, which led to many confused hours trying to figure out 
                            what was wrong. 
                        </p>
                    </div>

                </div>
            </div>

            <div uk-grid>
                <div class="uk-grid-item-match uk-width-1-3@s">
                    <div>
                        <h3>Lessons</h3>
                    </div>
                </div>
                <div class="uk-width-2-3@s">

                    <div class="uk-text-left">
                        <p>
                            Here are the key lessons that we learned
                            <br>
                            <br>
                            - ChatGPT API requires a cash balance for tokens to be charged
                            <br>
                            - Was able to use my (Bernie's) phone hotspot for the networking practice outside of the lab
                            <br>
                            - We needed to use the pinout diagram in order to use the monitor. We were not able 
                            to get the monitor to work, until we used the diagram.
                            <br>
                            <br>
                            <img src="pinout.png" alt="pinout">
                            <br>
                            <br>
                            - Our first monitor was broken
                            <br>
                            - Pins for the ESP Room 32 to monitor were: Pin 21 for SDA, pin 22 for SCL

                            <br>
                            <br>
                            Useful links:
                            <br>
                            <br>
                            This video gave us some sample code and how to get API from Open AI: <a href="https://youtu.be/EAwh4ul-K0g?si=wSzjNgJkApbKlGqK"> video</a>.

                            <br>
                            <br>

                            <a href="https://github.com/ProfBoots/ChatGPT-On-Arduino/blob/main/ESP32_to_OpenAI_s_API/ESP32_to_OpenAI_s_API.ino"> Sample Code.</a>
                            <br>
                            <br>

                            <a href="https://www.electronicshub.org/esp32-pinout/"> Pinout diagram.</a>
                            <br>
                        </p>
                    </div>

                </div>
            </div>

            <div uk-grid>
                <div class="uk-grid-item-match uk-width-1-3@s">
                    <div>
                        <h3>Code</h3>
                    </div>
                </div>
                <div class="uk-width-2-3@s">

                    <div class="uk-text-left">
                        <p>
                            <pre><code>#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

// Replace with your network credentials
const char* ssid     = "**********";
const char* password = "********";

// Replace with your OpenAI API key
const char* apiKey = "************";

String apiUrl = "https://api.openai.com/v1/chat/completions";
String finalPayload = "";

bool initialPrompt = true;
bool gettingResponse = true;

HTTPClient http;

#define SCREEN_WIDTH 128 // OLED display width, in pixels
#define SCREEN_HEIGHT 64 // OLED display height, in pixels
#define OLED_RESET -1    // Reset pin # (or -1 if sharing Arduino reset pin)
#define SCREEN_ADDRESS 0x3C ///< See datasheet for Address; 0x3D for 128x64, 0x3C for 128x32
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

void setup() {
    // Initialize Serial
    Serial.begin(9600);

    // Initialize OLED display
    if (!display.begin(SSD1306_SWITCHCAPVCC, SCREEN_ADDRESS)) {
    Serial.println(F("SSD1306 allocation failed"));
    for (;;) ; // Don't proceed, loop forever
    }

    // Connect to Wi-Fi network
    displayMessage("Connecting to WiFi...");
    WiFi.mode(WIFI_STA);
    WiFi.begin(ssid, password);
    while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    }
    displayMessage("Connected");

    // Begin HTTP client
    http.begin(apiUrl);
}

void loop() {
    if(Serial.available() > 0)
    {
        String prompt = Serial.readStringUntil('\n');
        prompt.trim();
        Serial.print("USER:");
        Serial.println(prompt);
        gettingResponse = true;
        displayMessage("Connecting to ChatGPT...");
        chatGptCall(prompt);
    }
    delay(1);
} 

void chatGptCall(String payload)
{
    http.addHeader("Content-Type", "application/json");
    http.addHeader("Authorization", "Bearer " + String(apiKey));
    
    if(initialPrompt)
    {
    finalPayload = "{\"model\": \"gpt-3.5-turbo\",\"messages\": [{\"role\": \"user\", \"content\": \"" + payload + "\"}]}";
    initialPrompt = false;
    }
    else{
    finalPayload = finalPayload + ",{\"role\": \"user\", \"content\": \"" + payload + "\"}]}";
    }

    while(gettingResponse)
    {
    int httpResponseCode = http.POST(finalPayload);
    
    if (httpResponseCode == 200) {
        String response = http.getString();
    
        // Parse JSON response
        DynamicJsonDocument jsonDoc(1024);
        deserializeJson(jsonDoc, response);
        String outputText = jsonDoc["choices"][0]["message"]["content"];
        outputText.remove(outputText.indexOf('\n'));
        
        // Display the response on the OLED screen
        display.clearDisplay();
        display.setTextSize(1);
        display.setTextColor(SSD1306_WHITE);
        display.setCursor(0, 0);
        display.println("CHATGPT:");
        display.println(outputText);
        display.display();
        
        String returnResponse = "{\"role\": \"assistant\", \"content\": \"" + outputText + "\"}";

        finalPayload = removeEndOfString(finalPayload);
        finalPayload = finalPayload + "," + returnResponse;
        gettingResponse = false;
    } 
    else {
        //Serial.printf("Error %i \n", httpResponseCode);
        // Serial.println("Trying again");
    }
    getDelay();
    }
}

String removeEndOfString(String originalString)
{
    int stringLength = originalString.length();
    String newString = originalString.substring(0, stringLength - 2);
    return(newString);
}

void displayMessage(String message) {
    display.clearDisplay();
    display.setTextSize(1);
    display.setTextColor(SSD1306_WHITE);
    display.setCursor(0, 0);
    display.println(message);
    display.println("Please type message to ChatGPT");
    display.display();
}

void getDelay(){
    unsigned long initialMillis = millis();
    while ((initialMillis + 5000) >= millis()) {    
    }
}
                                
</code></pre>
                        </p>
                    </div>

                </div>
            </div>
        </div>
    </div>
</body>

</html>